{"version":3,"file":"ngx-onesignal.js","sources":["../../../projects/ngx-onesignal/src/lib/interface.ts","../../../projects/ngx-onesignal/src/lib/decorators.ts","../../../projects/ngx-onesignal/src/lib/service/one-signal.service.ts","../../../projects/ngx-onesignal/src/lib/one-signal.module.ts"],"sourcesContent":["/**\n * @see {@link https://github.com/OneSignal/OneSignal-Website-SDK/blob/master/src/utils/OneSignalStub.ts}\n */\nexport type OneSignalStubFuncionList =\n  | 'init'\n  | '_initHttp'\n  | 'isPushNotificationsEnabled'\n  | 'showHttpPrompt'\n  | 'registerForPushNotifications'\n  | 'setDefaultNotificationUrl'\n  | 'setDefaultTitle'\n  | 'syncHashedEmail'\n  | 'getTags'\n  | 'sendTag'\n  | 'sendTags'\n  | 'deleteTag'\n  | 'deleteTags'\n  | 'addListenerForNotificationOpened'\n  | 'getIdsAvailable'\n  | 'setSubscription'\n  | 'showHttpPermissionRequest'\n  | 'showNativePrompt'\n  | 'showSlidedownPrompt'\n  | 'getNotificationPermission'\n  | 'getUserId'\n  | 'getRegistrationId'\n  | 'getSubscription'\n  | 'sendSelfNotification'\n  | 'setEmail'\n  | 'logoutEmail'\n  | 'setExternalUserId'\n  | 'removeExternalUserId'\n  | 'getExternalUserId'\n  | 'provideUserConsent'\n  | 'isOptedOut'\n  | 'getEmailId';\n\nexport interface OneSignalStub {\n  init: (options: OneSignalOptions) => Promise<void>;\n  registerForPushNotifications: () => Promise<void>;\n  getUserId: () => Promise<string>;\n  getRegistrationId: () => Promise<any>;\n  getNotificationPermission: () => Promise<any>;\n  setSubscription: (unmute: boolean) => Promise<void>;\n  isPushNotificationsEnabled: (\n    cb?: (isEnabled: boolean) => void,\n  ) => Promise<boolean>;\n  isOptedOut: () => Promise<boolean>;\n  isPushNotificationsSupported: () => Promise<boolean>;\n  subscriptionChange: (fnc: (isSubscribed: boolean) => void) => Promise<void>;\n\n  push: (fnc: Array<string | any>) => Promise<any>;\n  on: (func: string, callback: (result: any) => void) => void;\n\n  context: {\n    serviceWorkerManager: {\n      getActiveState: () => Promise<string>;\n    };\n  };\n  sdkEnvironment: {\n    getWindowEnv: () => Promise<string>;\n  };\n}\n\n/**\n * initialize OneSignal.\n * @see {@link https://documentation.onesignal.com/docs/web-push-sdk#section--init-}\n */\nexport abstract class OneSignalOptions {\n  appId: string;\n  autoRegister?: boolean;\n  allowLocalhostAsSecureOrigin?: boolean;\n  [prop: string]: any;\n}\n","export function ExecIf(initProp: string) {\n  return (target: any, name: string, descriptor: PropertyDescriptor) => {\n    const method = descriptor.value;\n    descriptor.value = function() {\n      if (this[initProp]) {\n        return method.apply(this, arguments);\n      }\n      return void 0;\n    };\n  };\n}\n","import { Injectable, Inject } from '@angular/core';\nimport { DOCUMENT } from '@angular/common';\nimport {\n  OneSignalStub,\n  OneSignalOptions,\n  OneSignalStubFuncionList,\n} from '../interface';\nimport { ExecIf } from '../decorators';\nimport { BehaviorSubject } from 'rxjs';\nimport { map, shareReplay } from 'rxjs/operators';\n\ndeclare var OneSignal: OneSignalStub;\n\ninterface OnsSignalSubscribed {\n  isSubscribed: boolean;\n  userId: string;\n  registrationId: string;\n  notificationPermission: string;\n  optedOut: boolean;\n  serviceWorkerActive: string;\n}\n\nconst isSubscribe = ({\n  isSubscribed,\n  userId,\n  registrationId,\n  notificationPermission,\n  optedOut,\n  serviceWorkerActive,\n}: OnsSignalSubscribed): boolean =>\n  isSubscribed &&\n  Boolean(userId) &&\n  Boolean(registrationId) &&\n  notificationPermission === 'granted' &&\n  optedOut === false &&\n  Boolean(serviceWorkerActive);\n\nconst hasSubsctibed = (\n  oneSignal: OneSignalStub,\n): Promise<OnsSignalSubscribed> =>\n  Promise.all([\n    oneSignal.isPushNotificationsEnabled(),\n    oneSignal.getUserId(),\n    oneSignal.getRegistrationId(),\n    oneSignal.getNotificationPermission(),\n    oneSignal.isOptedOut(),\n    oneSignal.context.serviceWorkerManager.getActiveState(),\n  ]).then(\n    ([\n      isSubscribed,\n      userId,\n      registrationId,\n      notificationPermission,\n      optedOut,\n      serviceWorkerActive,\n    ]) => ({\n      isSubscribed,\n      userId,\n      registrationId,\n      notificationPermission,\n      optedOut,\n      serviceWorkerActive,\n    }),\n  );\n\n// @dynamic\n@Injectable({\n  providedIn: 'root',\n})\nexport class OneSignalService {\n  private scriptinitalize = false;\n  private readonly scriptURL = 'https://cdn.onesignal.com/sdks/OneSignalSDK.js';\n\n  private readonly isSupportedSubject$ = new BehaviorSubject<boolean>(false);\n  private readonly SubscribeStateSubject$ = new BehaviorSubject<\n    OnsSignalSubscribed\n  >({\n    isSubscribed: false,\n    userId: '',\n    registrationId: '',\n    notificationPermission: '',\n    optedOut: true,\n    serviceWorkerActive: '',\n  });\n  private readonly isOptedOutSubject$ = new BehaviorSubject<boolean>(false);\n  private readonly isPushNotificationsEnabledSubject$ = new BehaviorSubject<\n    boolean\n  >(false);\n  private readonly userIdSubject$ = new BehaviorSubject<string | null>(null);\n\n  /**\n   * @see {@link https://documentation.onesignal.com/docs/web-push-sdk#ispushnotificationssupported}\n   */\n  public readonly isSupported$ = this.isSupportedSubject$.asObservable();\n  /**\n   * @see {@link https://documentation.onesignal.com/docs/web-push-sdk#ispushnotificationsenabled}\n   */\n  public readonly isPushNotificationsEnabled$ = this.isPushNotificationsEnabledSubject$.asObservable();\n  /**\n   * @see {@link https://documentation.onesignal.com/docs/troubleshooting-web-push#3-check-if-you-are-subscribed}\n   */\n  public readonly subscribeState$ = this.SubscribeStateSubject$.asObservable().pipe(\n    shareReplay(1),\n  );\n  /**\n   * @see {@link https://documentation.onesignal.com/docs/troubleshooting-web-push#3-check-if-you-are-subscribed}\n   */\n  public readonly isSubscribe$ = this.subscribeState$.pipe(map(isSubscribe));\n  public readonly userId$ = this.userIdSubject$.asObservable();\n\n  public get isSupported(): boolean {\n    return this.isSupportedSubject$.value;\n  }\n\n  public get isSubscribe(): boolean {\n    return isSubscribe(this.SubscribeStateSubject$.value);\n  }\n\n  public get isInitialized(): boolean {\n    return this.scriptinitalize;\n  }\n\n  public get isOptedOut(): boolean {\n    return this.isOptedOutSubject$.value;\n  }\n\n  public get userId(): string {\n    return this.userIdSubject$.value;\n  }\n\n  @ExecIf('isInitialized')\n  public subscribe() {\n    if (this.isSupported) {\n      if (this.isOptedOutSubject$.value) {\n        OneSignal.setSubscription(true);\n      } else {\n        OneSignal.registerForPushNotifications();\n      }\n    }\n  }\n\n  /**\n   * call OneSignal.setSubscription(false)\n   * @see {@link https://documentation.onesignal.com/docs/web-push-sdk#section--setsubscription-}\n   */\n  @ExecIf('isInitialized')\n  public unsubscribe() {\n    if (this.isSubscribe) {\n      OneSignal.setSubscription(false);\n    }\n  }\n\n  /**\n   * https://documentation.onesignal.com/docs/web-push-sdk#section-loading-sdk-asynchronously\n   * @param items push([\"functionName\", param1, param2]);\n   * @example\n   * ngxOneSignal.push(['sendTag', 'key', 'value', function(tagsSent) {\n   *   // Callback called when tags have finished sending\n   * }]);\n   * // or\n   * ngxOneSignal.push(['sendTag', 'key', 'value']).then((tagsSent) => {\n   *   // Callback called when tags have finished sending\n   * });\n   */\n  @ExecIf('isInitialized')\n  public push(items: any[]) {\n    if (this.isSupported) {\n      return OneSignal.push(items);\n    } else {\n      return Promise.resolve();\n    }\n  }\n\n  constructor(\n    @Inject(DOCUMENT) private readonly doc: Document,\n    private readonly options: OneSignalOptions,\n  ) {\n    this.init();\n  }\n\n  private async init() {\n    try {\n      if (!this.scriptinitalize) {\n        await this.addScript();\n        await this.initOneSignal();\n        this.scriptinitalize = true;\n      }\n    } catch {\n      this.scriptinitalize = false;\n    }\n  }\n\n  private addScript() {\n    return new Promise<Event>((resolve, reject) => {\n      const head = this.doc.getElementsByTagName('head')[0];\n      const script = this.doc.createElement('script');\n      script.type = 'text/javascript';\n      script.onload = resolve;\n      script.onerror = reject;\n      script.src = this.scriptURL;\n      head.appendChild(script);\n    });\n  }\n\n  private async initOneSignal() {\n    await OneSignal.init({\n      ...this.options,\n    });\n\n    await OneSignal.on('subscriptionChange', async () => {\n      this.SubscribeStateSubject$.next(await hasSubsctibed(OneSignal));\n    });\n\n    // https://documentation.onesignal.com/docs/web-push-sdk#section-subscription-change\n    this.isSupportedSubject$.next(\n      await OneSignal.isPushNotificationsSupported(),\n    );\n    this.isPushNotificationsEnabledSubject$.next(\n      await OneSignal.isPushNotificationsEnabled(),\n    );\n    this.isOptedOutSubject$.next(await OneSignal.isOptedOut());\n    this.SubscribeStateSubject$.next(await hasSubsctibed(OneSignal));\n    this.userIdSubject$.next(await OneSignal.getUserId());\n  }\n}\n","import { NgModule, ModuleWithProviders } from '@angular/core';\nimport { OneSignalOptions } from './interface';\n\n@NgModule()\nexport class NgxOneSignalModule {\n  static forRoot(\n    options?: OneSignalOptions,\n  ): ModuleWithProviders<NgxOneSignalModule> {\n    return {\n      ngModule: NgxOneSignalModule,\n      providers: [{ provide: OneSignalOptions, useValue: options }],\n    };\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;4BA8DC;;;IAxBC,6BAAmD;;IACnD,qDAAkD;;IAClD,kCAAiC;;IACjC,0CAAsC;;IACtC,kDAA8C;;IAC9C,wCAAoD;;IACpD,mDAEsB;;IACtB,mCAAmC;;IACnC,qDAAqD;;IACrD,2CAA4E;;IAE5E,6BAAiD;;IACjD,2BAA4D;;IAE5D,gCAIE;;IACF,uCAEE;;;;;;;MAOkB,gBAAgB;CAKrC;;;IAJC,iCAAc;;IACd,wCAAuB;;IACvB,wDAAuC;;;;;;;;;;;;;SCvEzB,MAAM,CAAC,QAAgB;IACrC;;;;;;IAAO,CAAC,MAAW,EAAE,IAAY,EAAE,UAA8B;;cACzD,MAAM,GAAG,UAAU,CAAC,KAAK;QAC/B,UAAU,CAAC,KAAK;;;QAAG;YACjB,IAAI,IAAI,CAAC,QAAQ,CAAC,EAAE;gBAClB,OAAO,MAAM,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;aACtC;YACD,OAAO,KAAK,CAAC,CAAC;SACf,CAAA,CAAC;KACH,EAAC;AACJ;;;;;;;;;;ACGA,kCAOC;;;IANC,2CAAsB;;IACtB,qCAAe;;IACf,6CAAuB;;IACvB,qDAA+B;;IAC/B,uCAAkB;;IAClB,kDAA4B;;;MAGxB,WAAW;;;;AAAG,CAAC,EACnB,YAAY,EACZ,MAAM,EACN,cAAc,EACd,sBAAsB,EACtB,QAAQ,EACR,mBAAmB,GACC,KACpB,YAAY;IACZ,OAAO,CAAC,MAAM,CAAC;IACf,OAAO,CAAC,cAAc,CAAC;IACvB,sBAAsB,KAAK,SAAS;IACpC,QAAQ,KAAK,KAAK;IAClB,OAAO,CAAC,mBAAmB,CAAC,CAAA;;;MAExB,aAAa;;;;AAAG,CACpB,SAAwB,KAExB,OAAO,CAAC,GAAG,CAAC;IACV,SAAS,CAAC,0BAA0B,EAAE;IACtC,SAAS,CAAC,SAAS,EAAE;IACrB,SAAS,CAAC,iBAAiB,EAAE;IAC7B,SAAS,CAAC,yBAAyB,EAAE;IACrC,SAAS,CAAC,UAAU,EAAE;IACtB,SAAS,CAAC,OAAO,CAAC,oBAAoB,CAAC,cAAc,EAAE;CACxD,CAAC,CAAC,IAAI;;;;AACL,CAAC,CACC,YAAY,EACZ,MAAM,EACN,cAAc,EACd,sBAAsB,EACtB,QAAQ,EACR,mBAAmB,EACpB,MAAM;IACL,YAAY;IACZ,MAAM;IACN,cAAc;IACd,sBAAsB;IACtB,QAAQ;IACR,mBAAmB;CACpB,CAAC,EACH,CAAA;;;MAMU,gBAAgB;;;;;IAwG3B,YACqC,GAAa,EAC/B,OAAyB;QADP,QAAG,GAAH,GAAG,CAAU;QAC/B,YAAO,GAAP,OAAO,CAAkB;QAzGpC,oBAAe,GAAG,KAAK,CAAC;QACf,cAAS,GAAG,gDAAgD,CAAC;QAE7D,wBAAmB,GAAG,IAAI,eAAe,CAAU,KAAK,CAAC,CAAC;QAC1D,2BAAsB,GAAG,IAAI,eAAe,CAE3D;YACA,YAAY,EAAE,KAAK;YACnB,MAAM,EAAE,EAAE;YACV,cAAc,EAAE,EAAE;YAClB,sBAAsB,EAAE,EAAE;YAC1B,QAAQ,EAAE,IAAI;YACd,mBAAmB,EAAE,EAAE;SACxB,CAAC,CAAC;QACc,uBAAkB,GAAG,IAAI,eAAe,CAAU,KAAK,CAAC,CAAC;QACzD,uCAAkC,GAAG,IAAI,eAAe,CAEvE,KAAK,CAAC,CAAC;QACQ,mBAAc,GAAG,IAAI,eAAe,CAAgB,IAAI,CAAC,CAAC;;;;QAK3D,iBAAY,GAAG,IAAI,CAAC,mBAAmB,CAAC,YAAY,EAAE,CAAC;;;;QAIvD,gCAA2B,GAAG,IAAI,CAAC,kCAAkC,CAAC,YAAY,EAAE,CAAC;;;;QAIrF,oBAAe,GAAG,IAAI,CAAC,sBAAsB,CAAC,YAAY,EAAE,CAAC,IAAI,CAC/E,WAAW,CAAC,CAAC,CAAC,CACf,CAAC;;;;QAIc,iBAAY,GAAG,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC,CAAC;QAC3D,YAAO,GAAG,IAAI,CAAC,cAAc,CAAC,YAAY,EAAE,CAAC;QAqE3D,IAAI,CAAC,IAAI,EAAE,CAAC;KACb;;;;IApED,IAAW,WAAW;QACpB,OAAO,IAAI,CAAC,mBAAmB,CAAC,KAAK,CAAC;KACvC;;;;IAED,IAAW,WAAW;QACpB,OAAO,WAAW,CAAC,IAAI,CAAC,sBAAsB,CAAC,KAAK,CAAC,CAAC;KACvD;;;;IAED,IAAW,aAAa;QACtB,OAAO,IAAI,CAAC,eAAe,CAAC;KAC7B;;;;IAED,IAAW,UAAU;QACnB,OAAO,IAAI,CAAC,kBAAkB,CAAC,KAAK,CAAC;KACtC;;;;IAED,IAAW,MAAM;QACf,OAAO,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC;KAClC;;;;IAGM,SAAS;QACd,IAAI,IAAI,CAAC,WAAW,EAAE;YACpB,IAAI,IAAI,CAAC,kBAAkB,CAAC,KAAK,EAAE;gBACjC,SAAS,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;aACjC;iBAAM;gBACL,SAAS,CAAC,4BAA4B,EAAE,CAAC;aAC1C;SACF;KACF;;;;;;IAOM,WAAW;QAChB,IAAI,IAAI,CAAC,WAAW,EAAE;YACpB,SAAS,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC;SAClC;KACF;;;;;;;;;;;;;;IAeM,IAAI,CAAC,KAAY;QACtB,IAAI,IAAI,CAAC,WAAW,EAAE;YACpB,OAAO,SAAS,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;SAC9B;aAAM;YACL,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;SAC1B;KACF;;;;;IASa,IAAI;;YAChB,IAAI;gBACF,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE;oBACzB,MAAM,IAAI,CAAC,SAAS,EAAE,CAAC;oBACvB,MAAM,IAAI,CAAC,aAAa,EAAE,CAAC;oBAC3B,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;iBAC7B;aACF;YAAC,WAAM;gBACN,IAAI,CAAC,eAAe,GAAG,KAAK,CAAC;aAC9B;SACF;KAAA;;;;;IAEO,SAAS;QACf,OAAO,IAAI,OAAO;;;;;QAAQ,CAAC,OAAO,EAAE,MAAM;;kBAClC,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,oBAAoB,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;;kBAC/C,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,aAAa,CAAC,QAAQ,CAAC;YAC/C,MAAM,CAAC,IAAI,GAAG,iBAAiB,CAAC;YAChC,MAAM,CAAC,MAAM,GAAG,OAAO,CAAC;YACxB,MAAM,CAAC,OAAO,GAAG,MAAM,CAAC;YACxB,MAAM,CAAC,GAAG,GAAG,IAAI,CAAC,SAAS,CAAC;YAC5B,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;SAC1B,EAAC,CAAC;KACJ;;;;;IAEa,aAAa;;YACzB,MAAM,SAAS,CAAC,IAAI,mBACf,IAAI,CAAC,OAAO,EACf,CAAC;YAEH,MAAM,SAAS,CAAC,EAAE,CAAC,oBAAoB;;;YAAE;gBACvC,IAAI,CAAC,sBAAsB,CAAC,IAAI,CAAC,MAAM,aAAa,CAAC,SAAS,CAAC,CAAC,CAAC;aAClE,CAAA,EAAC,CAAC;;YAGH,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAC3B,MAAM,SAAS,CAAC,4BAA4B,EAAE,CAC/C,CAAC;YACF,IAAI,CAAC,kCAAkC,CAAC,IAAI,CAC1C,MAAM,SAAS,CAAC,0BAA0B,EAAE,CAC7C,CAAC;YACF,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,MAAM,SAAS,CAAC,UAAU,EAAE,CAAC,CAAC;YAC3D,IAAI,CAAC,sBAAsB,CAAC,IAAI,CAAC,MAAM,aAAa,CAAC,SAAS,CAAC,CAAC,CAAC;YACjE,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,MAAM,SAAS,CAAC,SAAS,EAAE,CAAC,CAAC;SACvD;KAAA;;;YA7JF,UAAU,SAAC;gBACV,UAAU,EAAE,MAAM;aACnB;;;;YA0G2C,QAAQ,uBAA/C,MAAM,SAAC,QAAQ;YA1KlB,gBAAgB;;;AA+HhB;IADC,MAAM,CAAC,eAAe,CAAC;;;;iDASvB;AAOD;IADC,MAAM,CAAC,eAAe,CAAC;;;;mDAKvB;AAeD;IADC,MAAM,CAAC,eAAe,CAAC;;;;4CAOvB;;;;;;IArGD,2CAAgC;;;;;IAChC,qCAA8E;;;;;IAE9E,+CAA2E;;;;;IAC3E,kDASG;;;;;IACH,8CAA0E;;;;;IAC1E,8DAES;;;;;IACT,0CAA2E;;;;;IAK3E,wCAAuE;;;;;IAIvE,uDAAqG;;;;;IAIrG,2CAEE;;;;;IAIF,wCAA2E;;IAC3E,mCAA6D;;;;;IAkE3D,+BAAgD;;;;;IAChD,mCAA0C;;;;;;;;MC3KjC,kBAAkB;;;;;IAC7B,OAAO,OAAO,CACZ,OAA0B;QAE1B,OAAO;YACL,QAAQ,EAAE,kBAAkB;YAC5B,SAAS,EAAE,CAAC,EAAE,OAAO,EAAE,gBAAgB,EAAE,QAAQ,EAAE,OAAO,EAAE,CAAC;SAC9D,CAAC;KACH;;;YATF,QAAQ;;;;;;;;;;;;;;;;;"}